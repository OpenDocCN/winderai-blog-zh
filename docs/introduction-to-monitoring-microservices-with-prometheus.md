# 使用 Prometheus 监控微服务简介

> 原文：<https://winder.ai/introduction-to-monitoring-microservices-with-prometheus/>

https://prometheus.io 是一个开源的时间序列数据库，专注于捕捉测量结果并通过 API 公开它们。我爱普罗米修斯，因为它如此简单；它的极简主义是它最大的特点。它通过从仪表化的应用程序中提取指标来实现这一点，而不是像许多竞争对手那样提取指标。换句话说，Prometheus 从应用程序中“抓取”指标。

这意味着它在分布式、云原生环境中工作得非常好。监控系统上的负载减轻了所有服务的负担。这具有连锁效应，意味着通过简单的复制支持 HA，通过分段支持扩展。

## 体系结构

![](img/30b214897e32e153a894365fb5839743.png)

#### 普罗米修斯建筑

Prometheus 直接或通过中间的推送网关从插装的应用程序中抓取*指标*。请将此视为一种缓冲形式。它接受并存储推送的指标，并为 prometheus 公开一个可废弃的 API。

大部分代码库和作者花费的精力都用在了如何存储时间序列数据上。默认情况下，这包括一个基于文件的数据存储，该存储具有良好的可扩展性和高效性。

Prometheus 包含一个简单的查询语言，允许您评估和聚合时间序列数据。查询是所有监控任务的基础，包括当前统计数据和警报的可视化。

最后，Prometheus 为外部消费者公开了一个 REST API，比如仪表板。

## 哪里效果好？

Prometheus 天生简单，非常适合基于微服务的关键任务应用。当所有的应用程序都失败时，Prometheus 将仍然运行。

它通过使用键值标签来很好地处理多维数据。根据标签过滤数据既快又容易。例如，您可以对相同类型的数据使用相同的指标名称，仅通过标签来区分上下文(例如状态代码)。

![](img/60ecfdd27572772e0438235a68635285.png)

## 它(试图)在哪里工作不好？

记住普罗米修斯*刮擦*数据。普罗米修斯进行刮擦的时间是不确定的。因此，如果您的用例需要精确的逐秒抓取，这可能不是一个好的选择。

此外，Prometheus 毫无保留地专注于 HTTP。如果您在一个不使用 HTTP 的单一的基于 SOAP 或基于 RPC 的环境中操作，您可能会遇到集成问题。

## 普罗米修斯 vs &mldr;

作者很好地描述了普罗米修斯公司的竞争对手。我推荐看普罗米修斯文档来做一个比较。

但总的来说，我认为普罗米修斯的极简主义是唯一的卖点。拉模型、对使用简单分发机制的关注以及入门的容易性都意味着它更容易在生产中运行。潜在的不利之处是它无耻地以开发者为中心，这意味着它可能很难向商业用户销售，尤其是在有这么多漂亮的商业智能营销材料的情况下。

## 数据模型

所有数据都存储为一个*时间序列*。即带有时间戳的测量。测量被称为*度量*。每个时间序列都由一个*指标名称*和一组*键值对*，也称为*标签*唯一标识。

这意味着*标签*代表一个*指标*的多个维度。指标名称和标签的组合产生一个指标。换句话说，每当您在一个指标上创建一个新的键-值对时，您将在数据库中获得一个新的时间序列。因此，要非常小心，你的键值对是受约束的。**不要**存储 id 或电子邮件地址之类的东西，这是无界的。

一个观察(他们称之为样本！)是一个`float64`值和一个毫秒精度时间戳的组合。普罗米修斯不存储字符串！它不是用来伐木的！

给定指标名称和键值标签，使用以下格式来处理指标:

```py
<metric name>{<label name>=<label value>, ...} 
```

## 度量的类型

Prometheus 通过四种不同类型的度量来满足不同类型的测量。

*   **计数器**:只会增加的累积指标。(例如，服务的请求、完成的任务、发生的错误)
*   **标尺**:可以任意上下的度量。(例如温度、内存使用情况)
*   **直方图**:连续变量的面元测量。(例如，延迟、请求持续时间、年龄)
*   **摘要**:类似于直方图，除了条柱被立即转换为集合(例如 99%百分点)。

如果您正在开发基于 REST 的服务，那么您通常可以用直方图来度量您感兴趣的大多数东西。这是因为你不仅得到了一系列的箱子，而且还得到了数据的总数。因此，您可以使用直方图来计算请求率、错误率和持续时间，只需一个指标。

但是请记住，直方图和计算分位数可能是昂贵的(与计数器的简单增量相比！).

此外，我会避免使用汇总，因为它会将您锁定在一个固定的集合上。使用直方图，您可以在以后改变主意(例如，从第 99 百分位切换到第 95 百分位)。

## 名字是怎么产生的？

当 Prometheus 抓取实例时，它会自动将某些标签添加到抓取的时间序列中:

*   `job`:目标所属的作业名称
*   `instance`:抓取的目标 url 的`host:port`组合。

- `up{job="<job-name>", instance="<instance-id>"}` : `1`如果实例是健康的，即可以到达，或者`0`如果清除失败。

*   `scrape_duration_seconds{job="<job-name>", instance="<instance-id>"}`:刮擦的持续时间。

还有其他一些人。`up`时间序列对于可用性监控特别有用。对于所有其他指标，**您**决定指标的名称和标签。

![](img/fd2276ed0807555f8e8c3f326047e8ba.png)

## 度量命名最佳实践

名字非常重要。他们在危机时刻推断意义。因为普罗米修斯是如此宽容，组织应该产生一个命名约定，以便:

*   您知道在开发过程中如何称呼您的度量标准
*   用户只需看一眼就能明白你的指标意味着什么

应该选择标签，以便区分指标的上下文。每个人都应该使用相同的惯例。

### 一致的基于域的前缀

前缀是指标名称中的第一个单词。通常被客户端库称为`namespace`。选择定义测量的**域**的前缀。

示例:

*   与 HTTP 相关的指标都应该有一个前缀 **http** : `http_request_duration_seconds`

*   特定于应用的指标应指一个域:`users_total`

*   默认情况下，许多库都会导出流程级指标:`process_cpu_seconds_total`

### 一致单位

使用 SI(国际单位制)单位。

例如

*   秒
*   字节
*   米

而不是毫秒、兆字节、公里等。

### 每公制一个单位

不要混合度量标准。例如:

*   一个实例报告秒，另一个报告小时
*   聚合指标。例如字节/秒。请使用两个指标。

### 后缀应该描述单位

复数形式。

示例:

*   `http_request_duration_seconds`
*   `node_memory_usage_bytes`
*   `http_requests_total`(无单位累计计数)
*   `process_cpu_seconds_total`(单位累计计数)

### 意思是一样的

在所有标签维度中，指标名称应该具有相同的含义。

例如

指标`http_requests_total`表示相同的东西，尽管有不同的标签，如下所示:

*   `http_requests_total{status=404}`
*   `http_requests_total{status=200}`
*   `http_requests_total{status=200, path="/users/"}`

### 测试名字是否有意义

作者提供的一个技巧非常有用:

> 所有维度的总和或平均值应该是有意义的(尽管不一定有用)

例如

*   在一个度量中各种队列的容量是好的，而将队列的容量与队列中的当前元素数量混合就不好了。

一般来说，将指标分割成单一的单元类型。

## 标记最佳实践

标签应该用来区分上下文。例如，因为 http 请求[表示相同的东西](#mean-the-same-thing)，所以它们应该被分组到相同的度量中，而不考虑生成度量的服务。为了将此服务与其他服务区分开来，我们应用标签来表示此服务的上下文。例如:

`api_http_requests_total` -区分请求类型:type = " create | update | delete "`api_request_duration_seconds`-区分请求阶段:stage="extract|transform|load "

不要将上下文放在指标名称中，因为这会引起混淆。此外，当我们执行聚合时，看到不同上下文的聚合真的很好。

### 1 标签=== 1 维度

每个新的键值对代表一个新的维度。如果您选择一个有许多值的键，这将大大增加必须存储的数据量。

例如，**不存储**:

*   ID 的
*   电子邮件地址
*   任何类型的时间戳
*   任何无限的事物

一般来说，**所有键值都必须是一个有界集合**。

## 资源

这些信息大部分来自优秀的普罗米修斯文档。但是有些建议是我自己的。

*   [普罗米修斯文档](https://prometheus.io/docs/)
*   [GRPC 编码，而不是文本](https://github.com/grpc-ecosystem/go-grpc-prometheus)
*   [指标命名最佳实践](https://prometheus.io/docs/practices/naming/)
*   [git lab 的普罗米修斯建筑公司](https://gitlab.com/gitlab-com/runbooks/blob/master/howto/monitoring-overview.md)
*   [我在 Promcon 2017 上关于在微服务中检测应用的演讲](https://winder.ai/monitor-my-socks-using-prometheus-in-a-polyglot-open-source-microservices-reference-architecture/)